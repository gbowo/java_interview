## Redis常见问题


### 使用场景

- 缓存：击穿、穿透、雪崩、双写一致、持久化、数据过期、淘汰策略
- 分布式锁：setnx、reddison

1. #### Redis的数据持久化策略有哪些？





2. #### 什么是缓存穿透，怎么解决？


- 查询一个**不存在**的数据，MySQL查询不到数据也不会直接写入缓存，就会导致每次请求都查数据库
- 解决方案一：**缓存空数据**，查询返回的数据为空，仍把这个空结果进行缓存
  - 优点：简单
  - 缺点：消耗内存，可能会发生不一致的问题
- 解决方案二：**布隆过滤器**
  - 优点：内存占用较少，没有多余key
  - 缺点：实现复杂，存在误判


3. #### 什么是布隆过滤器？

- **原理**：
 - bitmap（位圈）：相当于是一个以（bit）位为单位的数组，数组中每个单元只能存储二进制0或1
- **作用**：可以用于检索一个元素是否在一个集合中
- **误判率**：数组越小误判率越大。数组越大误判率越小，同时带来更多的内存消耗


4. #### 什么是缓存击穿，怎么解决？


- 给某一个key设置了过期时间，当key过期的时候，恰好这时间点**对这个key有大量的并发请求**过来，这些并发的请求可能会瞬间把DB压垮。
- 解决方案一：**互斥锁（分布式锁）**
  - 互斥锁只有一个
  - 线程1：
    - 查询缓存，未命中
    - 获取互斥锁
    - 查询数据库重建缓存数据
    - 写入缓存
    - 释放锁
  - 线程2：
    - 查询缓存，未命中
    - 获取互斥锁失败
    - 休眠一段时间后重试
    - 直至线程1释放锁后，缓存命中
  - 特点：强一致、性能差
- 解决方案二：**逻辑过期**
  - 不设置过期时间
  - 线程1：
    - 查询缓存、发现逻辑时间已过期
    - 获取互斥锁成功
    - 开启新线程，线程2：
      - 查询数据库重建缓存数据
      - 写入缓存，重置逻辑过期时间
      - 释放锁
  - 线程3：
    - 查询缓存发现逻辑时间已过期
    - 获取互斥锁失败
    - 返回过期数据
  - 特点：高可用、性能优，不能保证数据绝对一致


5. #### 什么是缓存雪崩，怎么解决？


- 缓存雪崩是指在同一时段**大量的缓存key同时失效**或者**Redis服务宕机**，导致**大量**请求到达数据库，带来巨大压力
- 解决方案：
  - 给不同的key的TTL添加随机值
  - 利用Redis集群提高服务的可用性 **哨兵模式** **集群模式**
  - 给缓存业务添加降级限流策略 **ngxin**或**spring cloud gateway**
  - 给业务添加多级缓存 **Guava**或**Caffeine**


6. #### redis双写问题


- 双写一致性：
  - 当修改了数据库的数据也要同时更新缓存的数据，缓存和数据库额数据要保持一致
    - 读操作：缓存命中，直接返回；缓存未命中查询数据库，写入缓存，设定超时时间
    - 写操作：延迟双删（删除缓存->修改数据库-延时->删除缓存）
  - 读多写少的情况：
    - 共享锁：读锁readLock，加锁之后，其他线程可以共享读操作
    - 排他锁：也叫独占锁writeLock，加锁之后，阻塞其他线程读写操作
    - 适用于强一致的情况，性能弱
  - **问题1：redis作为缓存，mysql的数据是如何与redis进行同步呢？**
    - 介绍自己简历上的业务。我们当时是把文章的热点数据存入到了缓存中，虽然是热点数据，但是实时要求性没那么高，所以采用的异步方案同步数据
    - 我们当时是把抢券的库存写入到缓存中，这个需要实时进行数据同步，为了保证数据的强一致，我们当时采用的是redisson提供的读写锁来保证数据的同步
  - **问题2：介绍一下异步的方案（redisson读写锁的方案）**
    - 允许延时一致的业务，采用异步通知
      - 使用MQ中间件，更新数据之后，通知缓存删除
      - 利用canal中间件，不需要修改业务代码，伪装为mysql的一个从节点，canal通过读取binlog数据更新缓存
    - 强一致的，采用Reddison提供的读写锁
      - 共享锁：读锁readLock，加锁之后，其他线程可以共享读操作
      - 排他锁：也叫独占锁writeLock，加锁之后，阻塞其他线程读写操作


1. #### Redis分布式锁如何实现

2. #### Redis实现分布式锁如何合理的控制锁的有效时长

3.  #### Redis的数据过期策略有哪些

4.  #### Redis的数据淘汰策略有哪些

### 其他面试题

1. #### Redis集群有哪些方案

2. #### 什么是Redis主从同步
   
3. #### 使用Redis是单点还是集群？哪种集群？

4. #### Redis分片集群中数据时怎么存储和读取的

5. #### Redis集群脑裂

6. #### 怎么保证redis的高并发高可用

7. #### 用过Redis的事务吗？事物的命令有哪些？

8. #### Redis是单线程的，但是为什么还这么快？